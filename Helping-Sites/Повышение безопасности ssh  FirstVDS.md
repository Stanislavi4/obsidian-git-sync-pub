---
created: 2024-02-21T17:07:48 (UTC +06:00)
tags: []
source: https://firstvds.ru/technology/povyshenie-bezopasnosti-ssh
author: 
---

# Повышение безопасности ssh | FirstVDS

> ## Excerpt
> Secure shell — основной инструмент для управления сервером. То, с чего начинается работа системного администратора. По умолчанию служба работает на 22 порту и подвержена множеству опасностей: брутфорс паролей ботнетом, целенаправленному подбору хакерами и даже DDoS. А утечка паролей и потеря доступа к серверу может привести к катастрофическим последствиям для бизнеса и психики. В этой статье мы расскажем, как сделать доступ по SSH максимально закрытым и избавить себя от всевозможных рисков.

---
_С чего начинается сервер?   
Со входа по SSH_

[**<u>Secure shell</u>**](https://firstvds.ru/technology/ssh-connection) — основной инструмент для управления сервером. То, с чего начинается работа системного администратора.

По умолчанию служба работает на 22 порту и подвержена множеству опасностей: брутфорс паролей ботнетом, целенаправленному подбору хакерами и даже DDoS. А утечка паролей и потеря доступа к серверу может привести к катастрофическим последствиям для бизнеса и психики.

В этой статье мы расскажем, как сделать доступ по SSH максимально закрытым и избавить себя от всевозможных рисков.

**Важный момент**: следует делать всё аккуратно и иметь в соседней вкладке терминала рабочую сессию, чтобы в случае возникновения проблем ~не выстрелить себе в колено~ была возможность откатить изменения. 

## Конфиг SSH

Первым делом правим в конфиге демона SSH:

```
<em> /etc/ssh/sshd_config</em>
```

И меняем дефолтные параметры:

```
<strong>Port <span>1480</span></strong>
```

Порт, на котором будет располагаться служба. Рекомендуется ставить значение выше 1024 — так как значения ниже зарезервированы определенными службами и чаще «пробиваются» сканерами портов. Максимальное возможное значение — 65535.  
В этом случае при коннекте необходимо добавлять ключ `-p`, пример `_ssh -p 4596 sanya@188.120.242.222_`

```
<strong>PubkeyAuthentication <span>yes</span></strong>
```

Разрешаем аутентификацию по ключам SSH. Рекомендуется использовать алгоритм `Ed25519`. В этом случае закрытый ключ хранится на вашем ПК, а открытый добавляется на сервер в файл `.ssh/authorized_keys` в директории нужного юзера.

```
<strong>PermitEmptyPasswords <span>no</span>
PasswordAuthentication <span>no</span></strong>
```

Отключение авторизации по паролю — каким бы он не был надежным, всегда есть вероятность его подбора. Важно убедиться, что подключение по SSH-ключам работает, иначе подключиться к серверу без VNC или rescue вы не сможете.

```
<strong>ListenAddress <span>188.120.242.222</span></strong>
```

Если на сервере несколько IP-адресов, то этим параметром мы указываем, какой именно IP на сервере должна слушать служба.

```
<strong>LoginGraceTime <span>1m</span></strong>
```

По умолчанию при подключении по SSH у вас есть две минуты, чтобы ввести пароль. Если не успеете, то соединение будет прервано. Ставим минуту или даже тридцать секунд.

_опционально:_

```
<strong>PermitRootLogin </strong><span><strong>no</strong></span>
```

Отключаем авторизацию суперпользователя root. Он имеет неограниченную власть над системой и именно к нему чаще всего пытаются подобрать пароль. Важно, чтобы в системе уже были созданы другие пользователи с sudo-правами, под которыми в дальнейшем будет осуществляться подключение по SSH.

```
<strong>AllowUsers <span>Darya Tolik</span></strong>
```

Разрешаем доступ по SSH только определенным юзерам. Чтобы они имели возможность получить доступ к привилегиям суперпользователя, необходимо внести их в файл `/etc/sudoers` или добавить юзера в группу `sudo`. Например `_usermod -aG sudo Tolik_`_._

```
<strong>ClientAliveInterval <span>600</span></strong>
```

Задается время (в секундах) бездействия сессии, после чего она будет прервана. Важно не ставить низкие значения, иначе кроме неудобств при работе вам это ничего не принесёт.

```
<strong>ClientAliveCountMax <span>0</span></strong>
```

Количество проверок активности сессии, тесно связанный с предыдущим параметром. Если в течение заданного количества попыток (по умолчанию три) сервер не получит ответа, то соединение завершится. Так как мы выставили значение **ClientAliveInterval** равное десяти минутам, то этот параметр можно выключить, задав ноль.

После всех настроек перезапускаем SSH ( текущая сессия при этом не обрывается):

```
<em>service sshd restart</em>
```

На выходе мы получаем нестандартный порт, который слушает определенный диапазон IP-адресов и доступ возможен только по ключу SSH или сверхнадежному паролю и не юзеру root. Как его сгенерировать и где хранить, можно прочитать в другой нашей [<u>статье</u>](https://firstvds.ru/blog/how-to-create-strong-password). 

## Фаервол

Помимо изменения настроек самой службы, следует также разрешить подключение только с определенных IP-адресов с помощью Iptables и блокировать слишком частые попытки авторизоваться с неправильным паролем используя Fail2ban.

### Iptables

Утилита для управления брандмауэром netfiler. Установлена по умолчанию. Пример команды:

```
<em>iptables -A INPUT -s  93.94.176.0/21 -p tcp --dport 22 -j ACCEPT</em>
```

Которая разрешает подключение по 22 порту из указанной подсети — если вы меняли порт на предыдущем шаге, то следует заменить его и здесь.

Для остальных диапазонов IP подключение можно запретить правилом:

```
<em>iptables -A INPUT  -p tcp -m tcp --dport 22 -j DROP</em>
```

Если вы ранее изменяли порт SSH, то соответственно необходимо поправить и правило.

### Fail2ban

Ставится командами `_apt/yum install fail2ban_` в зависимости от используемой ОС. Чтобы включить службу в автозагрузку используйте `systemctl enable fail2ban`

После установки защита SSH работает сразу. Можно подправить правила в файле `_/etc/fail2ban/jail.conf_` или создать отдельный конфиг `/etc/fail2ban/jail.d/ssh.conf`

В секции **\[ssh\]**  указываем желаемые параметры:

**ignoreip** — список адресов, которые не будут блокироваться при истечении неудачных попыток авторизации. Сюда следует добавить IP-адреса, к которым будете подключаться к серверу.

**findtime** — интервал времени, в течение которого считаются попытки подключения. Стандартное значение — 10 минут, рекомендуем ставить значение меньше, например, 5 минут.

**maxretry** — собственно, количество неудачных попыток авторизации перед тем, как адрес будет заблокирован. Ставим 5.

**bantime** — время, на которое будет блокироваться подозрительный адрес.

Пример настроек секции:

```
<em>[sshd]</em>
<em>enabled  = true</em>
<em>filter   = sshd</em>
<em>action   = iptables[name=SSH, port=ssh, protocol=tcp]</em>
<em>logpath  = /var/log/auth.log</em>
<em>findtime</em><em> </em><em>= 300</em>
<em>maxretry</em><em> </em><em>= 5</em>
<em>bantime </em><em> </em><em>= 7200</em>
```

Если в течение пяти минут будет три неудачных попыток авторизации, то адрес, попавший под санкции, будет заблокирован на два часа.

Список заблокированных адресов можно будет посмотреть командой:

```
<em>root@api:~# </em><strong><em>fail2ban-client status sshd</em></strong>
```

Пример вывода:

```
<em>Status for the jail: sshd</em>
<em>|- Filter</em>
<em>|  |- Currently failed:    0</em>
<em>|  |- Total failed:    0</em>
<em>|  `- File list:    /var/log/ssh-auth.log</em>
<em>`- Actions</em>
<em>   |- Currently banned:    11</em>
<em>   |- Total banned:    34</em>
<em>   `- Banned IP list:    118.172.217.23 123.207.231.244 138.68.75.113 150.158.179.239 154.221.19.204 192.144.171.119 20.46.114.59 202.115.29.234 45.135.232.165 46.101.132.159</em>
```

Таким образом, мы разрешаем подключаться только из определенной подсети, а частые неудачные попытки будут блокироваться.

## Двухфакторная аутентификация

2FA уже плотно вошла в нашу жизнь — это удобно и безопасно. Почему бы не сделать это и на сервере?  
Вам нужно установить пакет `_libpam-google-authenticator_` — на современных ОС он доступен в штатных репозиториях. После установки пакета запускаем команду:

```
<em>google-authenticator </em>
```

И утвердительно отвечаем на вопрос:

```
<em>Do you want authentication tokens to be time-based (y/n) </em><span><strong><em>y</em></strong></span>
```

После чего появится окно с QR-кодом, кодом верификации и резервные пароли: 

![](%D0%9F%D0%BE%D0%B2%D1%8B%D1%88%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D0%B8%20ssh%20%20FirstVDS/image1.png)

Сохраняем код себе, добавляем ключ в приложение.

Далее последует вопрос, сохранить ли конфигурацию в файле `.google_authenticator` домашней директории. Отвечаем утвердительно на этот и все последующие вопросы.

После чего в конфиге `_/etc/pam.d/sshd_` добавляем строку:

```
<em>auth required pam_google_authenticator.so</em>
```

Меняем в `_/etc/ssh/sshd_config_` параметр `_ChallengeResponseAuthentication_` на `**_yes_**`

И перезапускаем SSH  командой `_service sshd restart_`

Теперь при подключении к серверу после ввода пароля будет запрашиваться код подтверждения.

## Панели управления

Помимо самого сервера нужно также позаботиться и о доступах в личный кабинет и панель управления сервером. Имея доступ к VNC или кнопкам управления, злоумышленник может, например, переустановить ОС на сервере и все данные будут утеряны. Или бесконечно прожимать кнопку перезагрузки, что тоже неприятно. 

В панелях управления Billmanager/VMmanager/DCImanager/ISPmanager вы можете также настроить [<u>двухфакторную аутентификацию</u>](https://firstvds.ru/technology/client-area-access#2fa) через Google Autentificator.
